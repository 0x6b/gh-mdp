<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{file_path}} - GFM Preview</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 208 128'><rect width='198' height='118' x='5' y='5' ry='10' stroke='%23000' stroke-width='10' fill='none'/><path d='M30 98V30h20l20 25 20-25h20v68H90V59L70 84 50 59v39zm125 0l-30-33h20V30h20v35h20z'/></svg>">
  <link rel="stylesheet" href="/assets/github-markdown.min.css">
  <link rel="stylesheet" href="/assets/highlight-github.min.css" media="(prefers-color-scheme: light)">
  <link rel="stylesheet" href="/assets/highlight-github-dark.min.css" media="(prefers-color-scheme: dark)">
  <style>
    :root {
      --bg: #f6f8fa; --card: #fff; --border: #d0d7de; --accent: #0969da;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #161b22; --card: #0d1117; --border: #30363d; --accent: #58a6ff; }
      .hljs { background: #161b22 !important; }
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
    .header { position: sticky; top: 0; z-index: 100; background: var(--card); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; align-items: center; gap: 12px; }
    .header-icon { width: 20px; height: 20px; color: #000; }
    @media (prefers-color-scheme: dark) { .header-icon { color: #fff; } }
    .header-title { font-size: 14px; font-weight: 600; color: #000; }
    @media (prefers-color-scheme: dark) { .header-title { color: #fff; } }
    .container { max-width: 980px; margin: 0 auto; padding: 32px 24px; }
    .markdown-body { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 32px 40px; min-height: calc(100vh - 150px); }
    .markdown-body pre code { font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace; font-size: 13px; }
  </style>
</head>
<body>
  <header class="header">
    <svg class="header-icon" viewBox="0 0 208 128"><rect width="198" height="118" x="5" y="5" ry="10" stroke="currentColor" stroke-width="10" fill="none"/><path fill="currentColor" d="M30 98V30h20l20 25 20-25h20v68H90V59L70 84 50 59v39zm125 0l-30-33h20V30h20v35h20z"/></svg>
    <span class="header-title">{{file_path}}</span>
  </header>
  <main class="container"><article class="markdown-body" id="content">{{content}}</article></main>
  <script src="/assets/highlight.min.js"></script>
  <script src="/assets/morphdom.min.js"></script>
  <script>
    const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
    const highlightCode = () => $$('pre code:not(.hljs)').forEach(b => hljs.highlightElement(b));
    highlightCode();
    const findAnchor = () => {
      let best = null, bestOff = Infinity;
      for (const el of $$('#content h1,#content h2,#content h3,#content h4,#content p,#content li,#content pre')) {
        const off = el.getBoundingClientRect().top;
        if (off >= -50 && off < bestOff) { best = el; bestOff = off; }
      }
      return best ? { tag: best.tagName, text: best.textContent.slice(0,100), off: bestOff } : null;
    };
    const restoreAnchor = a => {
      if (!a) return false;
      for (const el of $$(a.tag)) if (el.textContent.slice(0,100) === a.text) {
        window.scrollTo(0, el.getBoundingClientRect().top + window.scrollY - a.off);
        return true;
      }
      return false;
    };
    function connect() {
      const ws = new WebSocket(`ws://${location.host}/ws`);
      const content = $('#content');
      ws.onopen = () => {};
      ws.onclose = () => { setTimeout(connect, 2000); };
      ws.onmessage = e => {
        const data = JSON.parse(e.data);
        if (data.type !== 'update') return;
        const anchor = findAnchor(), scrollY = window.scrollY;
        const tmp = document.createElement('div');
        tmp.innerHTML = data.content;
        morphdom(content, tmp, {
          childrenOnly: true,
          onBeforeElUpdated: (from, to) => from.tagName === 'CODE' && from.classList.contains('hljs') && from.textContent === to.textContent ? false : true
        });
        highlightCode();
        requestAnimationFrame(() => { if (!restoreAnchor(anchor)) window.scrollTo(0, scrollY); });
      };
    }
    connect();
  </script>
</body>
</html>
